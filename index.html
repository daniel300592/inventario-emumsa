<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Inventario de Acero</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --primary-green: #006644;
      --secondary-green: #009977;
      --light-gray: #f0f0f0;
      --dark-gray: #333;
      --font-family: 'Roboto', sans-serif;
      --header-height: 72px;
      --table-head-height: 56px;
      --category-row-height: 40px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: var(--font-family); background: var(--light-gray); color: var(--dark-gray); }
    .site-header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; background: linear-gradient(90deg, var(--primary-green), var(--secondary-green)); z-index: 1000; }
    nav { display: flex; gap: 1rem; }
    nav button { background: transparent; border: none; color: #fff; font-weight: 500; padding: 0.5rem 1rem; cursor: pointer; transition: background 0.3s; }
    nav button:hover, nav button.active { background: rgba(255,255,255,0.2); }
    main { margin: calc(var(--header-height) + 1rem) auto 2rem; max-width: 1200px; padding: 0 1rem; }
    h2 { font-size: 1.75rem; margin-bottom: 1rem; border-bottom: 2px solid var(--primary-green); padding-bottom: 0.5rem; }
    .flex { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .box { background: #fff; border-radius: 8px; padding: 1.5rem; flex: 1; min-width: 280px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
    input, select, button[type="submit"] { width: 100%; padding: 0.6rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    button[type="submit"] { background: var(--primary-green); color: #fff; border: none; cursor: pointer; transition: background 0.3s; }
    button[type="submit"]:hover { background: var(--secondary-green); }
    .error { color: #c00; font-size: 0.9rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; background: #fff; }
    thead th { position: sticky; top: var(--header-height); height: var(--table-head-height); background: var(--primary-green); color: #fff; padding: 0.75rem 1rem; text-align: left; z-index: 3; }
    th, td { padding: 0.75rem 1rem; text-align: left; }
    tbody tr:nth-child(even) { background: var(--light-gray); }
    .category-row td { position: sticky; top: calc(var(--header-height) + var(--table-head-height)); background: #c8e6c9; font-weight: bold; height: var(--category-row-height); z-index: 2; }
    tbody tr:hover { background: rgba(255, 0, 0, 0.1); }
    tbody td:nth-child(1), tbody td:nth-child(2), tbody td:nth-child(3) { font-weight: 700; }
    #pesos-entrada-container { display: flex; flex-direction: column; align-items: center; }
    #pesos-entrada-container label { width: 200px; }
  </style>
</head>
<body>
  <header class="site-header">
    <nav>
      <button data-target="movimientos" class="active">Movimientos</button>
      <button data-target="nuevo-item">Nuevo Ítem</button>
      <button data-target="reportes">Reportes</button>
    </nav>
    <img src="logo-con-nombre-transparencia.png" alt="Logo" style="height:50px;">
  </header>
  <main>
    <section id="movimientos" class="active">
      <h2>Movimientos de Material</h2>
      <div class="flex">
        <div class="box">
          <h3>Entrada de Material</h3>
          <form id="form-entrada">
            <label>Material<br><input list="datalist-entrada" id="entrada-material" required><datalist id="datalist-entrada"></datalist></label>
            <div id="error-entrada-material" class="error"></div>
            <label>Calibre<br><select id="entrada-calibre"><option disabled selected>Seleccione calibre</option></select></label>
            <div id="pesos-entrada-container">
              <label>Peso (kg)<br><input type="number" step="0.01" class="entrada-peso" required></label>
            </div>
            <button type="submit">Registrar Paquetes</button>
          </form>
        </div>
        <div class="box">
          <h3>Salida de Material</h3>
          <form id="form-salida">
            <label>Material<br><input list="datalist-salida" id="salida-material" required><datalist id="datalist-salida"></datalist></label>
            <div id="error-salida-material" class="error"></div>
            <label>Calibre<br><select id="salida-calibre"><option disabled selected>Seleccione calibre</option></select></label>
            <label>Paquete<br><select id="salida-paquete"><option disabled selected>Seleccione paquete</option></select></label>
            <label>Peso a descontar (kg)<br><input type="number" step="0.01" id="salida-peso" required></label>
            <button type="submit">Registrar Salida</button>
          </form>
        </div>
      </div>
      <h3>Inventario</h3>
      <table id="tabla-inventario">
        <thead><tr id="inv-headers"></tr></thead>
        <tbody id="inv-body"></tbody>
      </table>
    </section>
    <section id="nuevo-item">
      <h2>Alta de Nuevo Ítem</h2>
      <div class="box">
        <form id="form-nuevo-item">
          <label>Nombre<br><input type="text" id="nuevo-nombre" required></label>
          <label>Calibre<br><input type="text" id="nuevo-calibre" required></label>
          <label>Categoría<br><select id="nuevo-categoria"></select></label>
          <button type="submit">Agregar Ítem</button>
          <div id="error-nuevo-item" class="error"></div>
        </form>
      </div>
    </section>
    <section id="reportes">
      <h2>Reportes</h2>
      <div class="box">
        <label>Desde<br><input type="date" id="fecha-desde"></label>
        <label>Hasta<br><input type="date" id="fecha-hasta"></label>
        <button type="submit" id="btn-reporte">Generar</button>
        <div class="flex"><div class="box">Entradas:<div id="total-entradas">0</div></div><div class="box">Salidas:<div id="total-salidas">0</div></div></div>
      </div>
    </section>
  </main>
  <script>
    firebase.initializeApp({apiKey:'AIzaSyCgDCzu5_k2_k1fb3vghS7MrZez87n8qjg',authDomain:'inventario-emumsa.firebaseapp.com',projectId:'inventario-emumsa'});
    const db = firebase.firestore();
    const categories = ['Tubería de Diámetro Menor','Tubería de Diámetro Mayor','PTR Negro Cuadrado','PTR Negro Rectangular','Polín Monten','Tubería Galvanizada','PTR Galvanizado','Varios'];
    let materialNames = [];
    function setupNav() {
      document.querySelectorAll('nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.dataset.target;
          document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
          document.getElementById(target).classList.add('active');
          document.getElementById(target).scrollIntoView({ behavior: 'smooth', block: 'start' });
          if (target === 'movimientos') renderInventario();
        });
      });
    }
    async function loadMaterialNames() {
      const snap = await db.collection('materiales').get();
      materialNames = [...new Set(snap.docs.map(d => d.data().nombre))].sort();
      ['datalist-entrada','datalist-salida'].forEach(id => {
        const dl = document.getElementById(id); dl.innerHTML = '';
        materialNames.forEach(n => dl.appendChild(new Option(n)));
      });
    }
    function populateCategorias() {
      const sel = document.getElementById('nuevo-categoria'); sel.innerHTML = '';
      categories.forEach(c => sel.appendChild(new Option(c, c)));
    }
    async function cargarCalibres(name, id) {
      const sel = document.getElementById(id); sel.innerHTML = '<option disabled selected>Seleccione calibre</option>';
      const snap = await db.collection('materiales').where('nombre','==',name).get();
      snap.docs.forEach(d => sel.appendChild(new Option(d.data().calibre, d.id)));
    }
    async function cargarPaquetes(calId, id) {
      const sel = document.getElementById(id); sel.innerHTML = '<option disabled selected>Seleccione paquete</option>';
      const snap = await db.collection('paquetes').where('materialId','==',calId).where('estado','==','activo').get();
      snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b) => a.fecha_ingreso.toDate() - b.fecha_ingreso.toDate())
        .forEach(p => sel.appendChild(new Option(p.peso_actual.toFixed(2)+' kg', p.id)));
    }
    async function renderInventario() {
      const head = document.getElementById('inv-headers'), body = document.getElementById('inv-body');
      head.innerHTML = ''; body.innerHTML = '';
      const mats = await db.collection('materiales').get();
      const pkgsSnap = await db.collection('paquetes').where('estado','==','activo').get();
      const map = {};
      pkgsSnap.docs.forEach(d => {
        const D = d.data();
        map[D.materialId] = map[D.materialId]||[];
        map[D.materialId].push({ id: d.id, peso: D.peso_actual, fecha: D.fecha_ingreso.toDate() });
      });
      let maxP = 0, sumGeneral = 0;
      const rows = mats.docs.map(m => {
        const D = m.data();
        const list = (map[m.id]||[]).sort((a,b)=>a.fecha-b.fecha);
        const pesos = list.map(x => x.peso.toFixed(2));
        maxP = Math.max(maxP, pesos.length);
        return { id: m.id, cat: D.categoriaId||'Varios', nombre: D.nombre, calibre: D.calibre, pesos, pids: list.map(x=>x.id) };
      }).sort((a,b)=>a.nombre.localeCompare(b.nombre)||a.calibre.localeCompare(b.calibre));
      ['Material','Calibre','Total',...Array.from({length:maxP},(_,i)=>`Pk ${i+1}`)].forEach(txt=>{
        const th = document.createElement('th'); th.textContent = txt; head.appendChild(th);
      });
      categories.forEach(cat => {
        const grp = rows.filter(r=>r.cat===cat);
        if (!grp.length) return;
        const trC = document.createElement('tr'); trC.classList.add('category-row');
        const tdC = document.createElement('td'); tdC.colSpan = 3+maxP; tdC.textContent = cat;
        trC.appendChild(tdC); body.appendChild(trC);
        grp.forEach(r => {
          const tr = document.createElement('tr');
          const total = r.pesos.reduce((s,p)=>s+parseFloat(p),0);
          sumGeneral += total;
          const totalStr = total.toFixed(2);
          [r.nombre,r.calibre,totalStr].forEach(txt=>{ const td=document.createElement('td'); td.textContent = txt; tr.appendChild(td); });
          r.pesos.forEach(p=>{ const td=document.createElement('td'); td.textContent = p; tr.appendChild(td); });
          for (let i=r.pesos.length;i<maxP;i++) tr.appendChild(document.createElement('td'));
          body.appendChild(tr);
        });
      });
      const trSum = document.createElement('tr');
      const tdLabel = document.createElement('td'); tdLabel.colSpan = 2; tdLabel.textContent = 'TOTAL GENERAL'; tdLabel.style.fontWeight = '700'; trSum.appendChild(tdLabel);
      const tdSum = document.createElement('td'); tdSum.textContent = sumGeneral.toFixed(2); tdSum.style.fontWeight = '700'; trSum.appendChild(tdSum);
      for (let i=0;i<maxP;i++) trSum.appendChild(document.createElement('td'));
      body.appendChild(trSum);
    }
    document.getElementById('entrada-material').addEventListener('change',e=>cargarCalibres(e.target.value,'entrada-calibre'));
    const sm = document.getElementById('salida-material'); if (sm) sm.addEventListener('change',e=>cargarCalibres(e.target.value,'salida-calibre'));
    document.getElementById('entrada-calibre').addEventListener('change',()=>{
      document.getElementById('pesos-entrada-container').innerHTML =
        '<label>Peso (kg)<br><input type="number" step="0.01" class="entrada-peso" required></label>';
    });
    document.getElementById('pesos-entrada-container').addEventListener('input',e=>{
      if (e.target.classList.contains('entrada-peso')) {
        const last = [...document.querySelectorAll('.entrada-peso')].pop();
        if (last.value) {
          const lbl = document.createElement('label'); lbl.innerHTML = 'Peso (kg)<br>';
          const ip = document.createElement('input'); ip.type = 'number'; ip.step = '0.01'; ip.className = 'entrada-peso'; ip.required = false;
          lbl.appendChild(ip);
          document.getElementById('pesos-entrada-container').appendChild(lbl);
        }
      }
    });
    document.getElementById('form-entrada').addEventListener('submit',async e=>{
      e.preventDefault();
      const m=document.getElementById('entrada-material').value;
      const c=document.getElementById('entrada-calibre').value;
      const pesos=[...document.querySelectorAll('.entrada-peso')].map(i=>parseFloat(i.value)).filter(v=>v);
      for(const p of pesos) await db.collection('paquetes').add({ materialId:c,peso_inicial:p,peso_actual:p,fecha_ingreso:new Date(),estado:'activo' });
      e.target.reset();
      document.getElementById('pesos-entrada-container').innerHTML =
        '<label>Peso (kg)<br><input type="number" step="0.01" class="entrada-peso" required></label>';
      renderInventario();
    });
    document.getElementById('salida-calibre').addEventListener('change',e=>cargarPaquetes(e.target.value,'salida-paquete'));
    document.getElementById('form-salida').addEventListener('submit',async e=>{
      e.preventDefault();
      const pkg=document.getElementById('salida-paquete').value;
      const p=parseFloat(document.getElementById('salida-peso').value);
      const ref=db.collection('paquetes').doc(pkg);
      const snap=await ref.get();
      const newP=snap.data().peso_actual-p;
      await ref.update({ peso_actual:newP, estado: newP<=0? 'agotado':'activo' });
      e.target.reset();
      renderInventario();
    });
    document.getElementById('form-nuevo-item').addEventListener('submit',async e=>{
      e.preventDefault();
      const n=document.getElementById('nuevo-nombre').value.trim();
      const cl=document.getElementById('nuevo-calibre').value.trim();
      const cat=document.getElementById('nuevo-categoria').value;
      const err=document.getElementById('error-nuevo-item'); err.textContent='';
      if(!n||!cl){ err.textContent='Nombre y calibre obligatorios'; return; }
      const ex=await db.collection('materiales').where('nombre','==',n).where('calibre','==',cl).get();
      if(!ex.empty){ err.textContent='Ítem ya existe'; return; }
      await db.collection('materiales').add({ nombre:n, calibre:cl, categoriaId:cat });
      e.target.reset();
      await loadMaterialNames();
      renderInventario();
    });
    (async()=>{ setupNav(); populateCategorias(); await loadMaterialNames(); renderInventario(); })();
  </script>
</body>
</html>
